openapi: 3.0.3
info:
  title: Transaction Management API
  description: |
    A RESTful API for managing financial transactions with comprehensive filtering, sorting, and analytics capabilities.

    ## Features
    - CRUD operations for transactions
    - Transaction status management (pending, success, failed)
    - Advanced filtering and pagination
    - Transaction summary and analytics dashboard
    - Real-time health monitoring

  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:4000
    description: Development server
  - url: https://staging.example.com
    description: Staging server
  - url: https://api.example.com
    description: Production server

tags:
  - name: Health
    description: API health check endpoints
  - name: Transactions
    description: Transaction management operations
  - name: Dashboard
    description: Analytics and summary endpoints

paths:
  /healthcheck:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the current status and version of the API
      operationId: healthCheck
      responses:
        "200":
          description: API is healthy and operational
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: available
                  system_info:
                    type: object
                    properties:
                      environment:
                        type: string
                        enum: [development, staging, production]
                        example: development
                      version:
                        type: string
                        example: 1.0.0

  /transactions:
    get:
      tags:
        - Transactions
      summary: Get all transactions
      description: Retrieve a paginated list of transactions with optional filtering and sorting
      operationId: getAllTransactions
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 1
          example: 1
        - name: page_size
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          example: 10
        - name: sort_by
          in: query
          description: |
            Field to sort by. Prefix with '-' for descending order.
            Available fields: id, user_id, amount, status, created_at
          required: false
          schema:
            type: string
            enum:
              - id
              - user_id
              - amount
              - status
              - created_at
              - -id
              - -user_id
              - -amount
              - -status
              - -created_at
            default: id
          example: id
        - name: status
          in: query
          description: Filter by transaction status
          required: false
          schema:
            type: string
            enum: [pending, failed, success]
          example: success
        - name: user_id
          in: query
          description: Filter by user ID
          required: false
          schema:
            type: integer
            minimum: 1
          example: 123
      responses:
        "200":
          description: Successfully retrieved transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Transaction"
                  metadata:
                    $ref: "#/components/schemas/Metadata"
        "400":
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags:
        - Transactions
      summary: Create a new transaction
      description: Creates a new transaction with pending status
      operationId: createTransaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransactionCreateRequest"
      responses:
        "201":
          description: Transaction created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Transaction"
        "400":
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /transactions/{id}:
    get:
      tags:
        - Transactions
      summary: Get transaction by ID
      description: Retrieve a specific transaction by its ID
      operationId: getTransactionById
      parameters:
        - name: id
          in: path
          description: Transaction ID
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Transaction retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Transaction"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      tags:
        - Transactions
      summary: Update transaction
      description: Update transaction amount and/or status. Uses optimistic locking to prevent concurrent modifications.
      operationId: updateTransaction
      parameters:
        - name: id
          in: path
          description: Transaction ID
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransactionUpdateRequest"
      responses:
        "200":
          description: Transaction updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Transaction"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/EditConflict"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags:
        - Transactions
      summary: Delete transaction
      description: Permanently delete a transaction by its ID
      operationId: deleteTransaction
      parameters:
        - name: id
          in: path
          description: Transaction ID
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Transaction deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Transaction"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /dashboard/summary:
    get:
      tags:
        - Dashboard
      summary: Get transaction summary
      description: |
        Retrieve transaction analytics including status distribution and rate percentages.
        Supports filtering by date range and user ID with pagination.
      operationId: getTransactionSummary
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 1
        - name: page_size
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: sort_by
          in: query
          description: |
            Field to sort by. Prefix with '-' for descending order.
            Available fields: id, user_id, amount, status, created_at
          required: false
          schema:
            type: string
            enum:
              - id
              - user_id
              - amount
              - status
              - created_at
              - -id
              - -user_id
              - -amount
              - -status
              - -created_at
            default: id
        - name: date_range
          in: query
          description: Filter transactions within the last N days (1-366)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 366
        - name: user_id
          in: query
          description: Filter by user ID
          required: false
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Summary retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/TransactionSummary"
                  metadata:
                    $ref: "#/components/schemas/Metadata"
        "400":
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  schemas:
    Transaction:
      type: object
      properties:
        id:
          type: integer
          description: Unique transaction identifier
          example: 1
        user_id:
          type: integer
          description: ID of the user who created the transaction
          example: 123
        amount:
          type: integer
          description: Transaction amount in smallest currency unit
          example: 10000
        status:
          type: string
          enum: [pending, failed, success]
          description: Current status of the transaction
          example: pending
        created_at:
          type: string
          format: date-time
          description: Timestamp when the transaction was created
          example: "2024-12-14T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the transaction was last updated
          example: "2024-12-14T10:30:00Z"

    TransactionCreateRequest:
      type: object
      required:
        - user_id
        - amount
      properties:
        user_id:
          type: integer
          minimum: 1
          description: ID of the user creating the transaction
          example: 123
        amount:
          type: integer
          minimum: 1
          description: Transaction amount in smallest currency unit
          example: 10000

    TransactionUpdateRequest:
      type: object
      properties:
        amount:
          type: integer
          minimum: 1
          description: Updated transaction amount (optional)
          example: 15000
        status:
          type: string
          enum: [pending, failed, success]
          description: Updated transaction status (optional)
          example: success
      description: At least one field (amount or status) should be provided, though both are technically optional

    TransactionSummary:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: "#/components/schemas/Transaction"
          description: List of transactions matching the filter criteria
        summary:
          type: object
          properties:
            total_transaction:
              type: integer
              description: Total number of transactions
              example: 100
            pending:
              $ref: "#/components/schemas/StatusCount"
            success:
              $ref: "#/components/schemas/StatusCount"
            failed:
              $ref: "#/components/schemas/StatusCount"

    StatusCount:
      type: object
      properties:
        count:
          type: integer
          description: Number of transactions with this status
          example: 33
        rate_percentage:
          type: number
          format: float
          description: Percentage of total transactions (rounded to 2 decimals)
          example: 33.33

    Metadata:
      type: object
      properties:
        current_page:
          type: integer
          description: Current page number
          example: 1
        page_size:
          type: integer
          description: Number of items per page
          example: 10
        first_page:
          type: integer
          description: First page number (always 1)
          example: 1
        last_page:
          type: integer
          description: Last page number based on total records
          example: 10
        total_records:
          type: integer
          description: Total number of records matching the query
          example: 100

    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: HTTP status text
              example: Bad Request
            message:
              type: string
              description: Human-readable error message
              example: Invalid request parameters
            details:
              description: Additional error details (optional)
              oneOf:
                - type: string
                - type: object

    ValidationError:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: Unprocessable Entity
            message:
              type: string
              example: unable to proccess request because some malformed input
            details:
              type: object
              additionalProperties:
                type: string
              example:
                user_id: "UserId is a required field"
                amount: "Amount must be 1 or greater"

  responses:
    BadRequest:
      description: Bad request - invalid parameters or malformed JSON
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: Bad Request
              message: Invalid JSON format

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: Not Found
              message: the requested resource could not be found

    ValidationError:
      description: Validation error - request data failed validation rules
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ValidationError"

    EditConflict:
      description: Edit conflict - resource was modified by another request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: Conflict
              message: unable to update the record due to an edit conflict, please try again

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: Internal Server Error
              message: the server encountered a problem and could not process your request
